#!/usr/bin/env bash
#
# Build Docker images for various Linux distros. These will be used to manually test the
# NadekoBot Manager scripts in different environments.
#
# NOTES:
#   - To run the images, use the following command:
#       - docker run --privileged --rm -it -v "$(pwd)/shared:/root/NadekoBot" <image>
#   - Upon running/accessing the container, you'll be prompted for a username and
#     password. Use the following credentials:
#       - Username: root
#       - Password: password
#   - To exit the container, execute `shutdown now`, instead of `exit`.
#   - WARNING: The images generated by this script are to be used for testing purposes
#     only. They are not designed for production use, due to:
#       - The hardcoded password.
#       - The use of the `--privileged` flag.
#       - Etc.
#
# Comment Key:
#   - ALT_EXEC: Images in 'distro_base' with this comment next to them, might need to be
#     run differently, for one or more reasons. As a result, you will most likely need
#     to bypass the login prompt (which typically won't show up) and 'exec' into the
#     container. For these images, use the following commands:
#       - docker run --privileged --rm -d -v "$(pwd)/shared:/root/NadekoBot" <image>
#       - docker exec -it <container_id> /bin/bash
#
########################################################################################

set -e

# This associative array maps a distro key to the base image.
# (Use official images when available. For Linux Mint, we rely on community images.)
declare -A distros_base=(
    [ubuntu-24.04]="ubuntu:24.04"
    [ubuntu-22.04]="ubuntu:22.04"
    [debian-12]="debian:12"
    [linuxmint-22]="linuxmintd/mint22.1-amd64"  # Community image. | Uses Ubuntu 24.04.1?
    [linuxmint-21]="linuxmintd/mint21.3-amd64"  # Community image.
    [fedora-41]="fedora:41"  # ALT_EXEC
    [fedora-40]="fedora:40"  # ALT_EXEC
    [almalinux-9]="almalinux:9"  # ALT_EXEC
    [almalinux-8]="almalinux:8"  # ALT_EXEC
    [rocky-9]="rockylinux:9"
    [rocky-8]="rockylinux:8"  # ALT_EXEC
    [opensuse-leap-15.6]="opensuse/leap:15.6"
    [opensuse-tumbleweed]="opensuse/tumbleweed"
    [arch]="archlinux:latest"
)

# This associative array maps the distro key to its package manager.
declare -A pkg_manager=(
    [ubuntu-24.04]="apt"
    [ubuntu-22.04]="apt"
    [debian-12]="apt"
    [linuxmint-22]="apt"
    [linuxmint-21]="apt"
    [fedora-41]="dnf"
    [fedora-40]="dnf"
    [almalinux-9]="dnf"
    [almalinux-8]="dnf"
    [rocky-9]="dnf"
    [rocky-8]="dnf"
    [opensuse-leap-15.6]="zypper"
    [opensuse-tumbleweed]="zypper"
    [arch]="pacman"
)


## Build an image for each distro.
for distro in "${!distros_base[@]}"; do
    base_image="${distros_base[$distro]}"
    manager="${pkg_manager[$distro]}"
    image_tag="nadekobot-testing-${distro}"

    echo "----------------------------------------"
    echo "Building image: $image_tag"
    echo "  Base image: $base_image"
    echo "  Package manager: $manager"
    docker build --build-arg BASE_IMAGE="$base_image" \
        --build-arg PKG_MANAGER="$manager" -t "$image_tag" .
    echo "Built $image_tag"
done

echo "----------------------------------------"
echo "All images built successfully."
